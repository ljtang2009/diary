<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8" />
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<link rel="stylesheet" href="css/mui.min.css">
		<title>diary</title>
		<style>
		
			.svgTimelineContainer {
				display: flex; 
				justify-content:center; 
				flex-wrap: wrap;
				width: 56px;
				height: 42px;
			}
		
			.svgTimeline {
				width: 14px;;
			}
		
			/**
			 * 日记内容样式
			 */
			.divDiaryContentItem {
			  position: relative;
			  border-radius: 1px;
			  height: 75px; 
			  margin: 10px 10px 0 10px;
			  display: flex; 
			  padding: 6px 0 6px 6px;
			}
			
			.divDiaryContentItem:after, .divDiaryContentItem:before {
			  border: solid transparent;
			  content: ' ';
			  height: 0;
			  left: -18px;
			  position: absolute;
			  width: 0;
			}
			
			.divDiaryContentItem:after {
			  border-width: 9px;
			  top: 10px;
			}
			
			/**
			 * 日记文字内容样式
			 */
			.divDiaryContentText{
				flex-grow: 100; 
				width: 50px; 
				font-size: 14px;
			}
			
			/**
			 * 日记图片的样式
			 */
			.divDiaryContentImg{
				margin-right: 6px;
			}
			
			.divDiaryContentImg > img{
				max-width: 100px; 
				height: 64px;
			}
			
			.divDiaryTimelineLeft{
				text-align: center; font-size: 12px; padding: 10px 0px 5px 10px;
			}
			
			.divTimelineLineContainer {
				width:30px; 
				text-align: center; 
				display: flex; 
				flex-direction: column;
			}
			
			.divTimelineLineContainer > .divTimelineLineUP {
				border-left: 1px solid; margin-left: 15px; height: 20px;
			}
			
			.divTimelineLineContainer > .divTimelineLineDown {
				border-left: 1px solid; margin-left: 15px; flex-grow: 100;
			}
			
			.divTimelineLineContainer > .divTimelineLineText {
				height: 20px; font-size: 20px;
			}
			
			.mui-table-view {
				background-color: transparent;
			}
			
			.mui-table-view:before, .mui-table-view:after{
				background-color: transparent;
			}
			
			.mui-table-view-cell {
				padding: 0px;
			}
			
			.mui-table-view-cell:after {
				background-color: transparent;
			}
			
			.mui-table-view-cell.mui-active {
				background-color: transparent;
			}
			
			.mui-table-view-cell > .mui-slider-handle {
				background-color: transparent;
			}
			
			.mui-table-view-cell > .mui-slider-right{
				padding-top: 10px;
				padding-bottom: 14px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<!--<a href="#" onclick="gotoDetail();">测试</a>-->
			<div id="divGB" style="z-index: 0; width: 100%;">
			</div>
			<div id="divMountain3" style="z-index: 1; width: 60%; position: absolute; right: 0px; background-repeat: no-repeat; background-size: 100% 100%;">
			</div>
			<div id="divMountain2" style="z-index: 2; width: 100%; position: absolute; left: 0px;background-repeat: no-repeat; background-size: 100% 100%;">
			</div>
			<div id="divMountain1" style="z-index: 3; width: 100%; position: absolute; left: 0px;background-repeat: no-repeat; background-size: 100% 100%;">
			</div>
			<div id="divMainButton" style="z-index: 4; position: absolute; border-radius: 100%;">
			</div>
			<div id="divDiaryList" style="z-index: 5; position: relative; margin-top: 0px; width: 100%; padding-bottom: 10px;">
				<ul id="ulDairyList" style="list-style-type:none; padding: 0; margin: 0;" class="mui-table-view">
				</ul>
			</div>
		</div>
		<script src="js/mui.min.js"></script>
		<script src="js/utility.js"></script>
		<script src="lib/greensock/TweenLite.min.js"></script>
		<script src="lib/greensock/plugins/CSSPlugin.min.js"></script>
		<script src="lib/greensock/plugins/ScrollToPlugin.min.js"></script>
		<script src="lib/clamp/clamp.min.js"></script>
		<script src="lib/handlebars/handlebars.min.js"></script>
		<script src="lib/moment/moment.min.js"></script>
		<script id="diaryItemTempte" type="text/x-handlebars-template">
			<div class="mui-slider-right mui-disabled">
				<a class="mui-btn mui-btn-red mui-icon mui-icon-trash"></a>
			</div>
			<div style="display: flex;" class="mui-slider-handle">
				<div class="divDiaryTimelineLeft">
					<div>{{yearMonth}}</div>
					<div>{{dayOfWeekChinese}}</div>
					<div class="svgTimelineContainer">
						<div><embed name='svg' src="image/weather/{{weather}}.svg" onload="changSvgColor(this);" class="svgTimeline" type="image/svg+xml" pluginspage="http://www.adobe.com/svg/viewer/install/"></embed></div>
						{{# if expression}}<div><embed name='svgTimeline' onload="changSvgColor(this);" src="image/expression/{{expression}}.svg" class="svgTimeline" type="image/svg+xml" pluginspage="http://www.adobe.com/svg/viewer/install/"></embed></div>{{/if}}
						{{# if hasPicture}}<div><embed name='svgTimeline' onload="changSvgColor(this);" src="image/fileIcon/picture.svg" class="svgTimeline" type="image/svg+xml" pluginspage="http://www.adobe.com/svg/viewer/install/"></embed></div>{{/if}}
						{{# if hasAudio}}<div><embed name='svgTimeline' onload="changSvgColor(this);" src="image/fileIcon/audio.svg" class="svgTimeline" type="image/svg+xml" pluginspage="http://www.adobe.com/svg/viewer/install/"></embed></div>{{/if}}
						{{# if hasVideo}}<div><embed name='svgTimeline' onload="changSvgColor(this);" src="image/fileIcon/video.svg" class="svgTimeline" type="image/svg+xml" pluginspage="http://www.adobe.com/svg/viewer/install/"></embed></div>{{/if}}
					</div>
				</div>
				<div class="divTimelineLineContainer">
					<div class="divTimelineLineUP" style="{{# if hasLast}}visibility: visible;{{~^~}}visibility: hidden;{{/if}}"></div>
					<div class="divTimelineLineText">{{day}}</div>
					<div class="divTimelineLineDown" style="{{# if hasNext}}visibility: visible;{{~^~}}visibility: hidden;{{/if}}"></div>
				</div>
				<div style="flex-grow: 100;">
					<div class="divDiaryContentItem">
						<div name="divDiaryText" class="divDiaryContentText">{{content}}</div>
						<div class="divDiaryContentImg" style="{{#if hasPicture}}display: block;{{~^~}}display: none;{{/if}}"><img src="{{image}}"></div>
					</div>
				</div>
			</div>
		</script>
		<script type="text/javascript">
			var divMountain1 = document.getElementById("divMountain1");
			var divMountain2 = document.getElementById("divMountain2");
			var divMountain3 = document.getElementById("divMountain3");
			var divMainButton = document.getElementById("divMainButton");
			var divDiaryList = document.getElementById('divDiaryList');
			var ulDairyList = document.getElementById('ulDairyList');
			var sourceDiaryItem = document.getElementById('diaryItemTempte').innerHTML;
			var templateDiaryItem = Handlebars.compile(sourceDiaryItem);
			var divMainButtonInitTop;		//主按钮初始化后的位置
			var divMountain1InitTop;		//山1初始化后的位置
			var divMountain2InitTop;		//山2初始化后的位置
			var divMountain3InitTop;		//山3初始化后的位置
			var touchStartY = 0;		//垂直方向拖动的起始位置
			var touchStartMainButtonTop;	//主按钮拖动前的位置
			var tweenAnimationUP;		//向上的动画对象
			var tweenAnimationDown;		//向下的动画对象
			var finishInit = false;		//是否完成初始化
			var tweenMainButtonAnimationBack;		//主按钮回弹的动画对象
			var tweenMountain1AnimationBack;		//山1回弹的动画对象
			var tweenMountain2AnimationBack;		//山2回弹的动画对象
			var tweenMountain3AnimationBack;		//山3回弹的动画对象
			var isIOS = false;		//是否是ios系统
			/**
			 * 区分时间的样式
			 */
			var styleWithTime;
			mui.init({
				swipeBack: false,		//关闭侧滑
				statusBarBackground: '#f7f7f7'
			});
			mui.plusReady(function(){
//				//开始拖动
//				document.body.addEventListener('touchstart', function (event) {
//					if (finishInit){
//						//停止主按钮上下晃动的动画
//						if(tweenAnimationUP){
//							tweenAnimationUP.kill();
//						}
//						if(tweenAnimationDown){
//							tweenAnimationDown.kill();
//						}
//						if(tweenMainButtonAnimationBack){
//							tweenMainButtonAnimationBack.kill();
//						}
//						if(tweenMountain1AnimationBack){
//							tweenMountain1AnimationBack.kill();
//						}
//						if(tweenMountain2AnimationBack){
//							tweenMountain2AnimationBack.kill();
//						}
//						if(tweenMountain3AnimationBack){
//							tweenMountain3AnimationBack.kill();
//						}
//						//获取拖动点初始位置
//						touchStartY = event.changedTouches[0].pageY;
//						touchStartMainButtonTop = divMainButton.offsetTop;
//					}
//				}, false);
//				//拖动中
//				document.body.addEventListener('touchmove', function (event) {
//					if (finishInit){
//						//拖动百分比，正式为下拉，负数为上拉
//						var touch_percent = (event.changedTouches[0].pageY - touchStartY) / window.innerHeight;
//						if (touch_percent > 0){
//							divMainButton.style.top = divMainButtonInitTop + (100 * touch_percent) + 'px';
//							divMountain1.style.top = divMountain1InitTop + (100 * touch_percent) + 'px';
//							divMountain2.style.top = divMountain2InitTop + (100 * touch_percent * 0.8) + 'px';
//							divMountain3.style.top = divMountain3InitTop + (100 * touch_percent * 0.6) + 'px';
//						}
//						else {
//							divMainButton.style.top = divMainButtonInitTop + (event.changedTouches[0].pageY - touchStartY) + 'px';
//							divMountain1.style.top = divMountain1InitTop + (event.changedTouches[0].pageY - touchStartY) + 'px';
//							divMountain2.style.top = divMountain2InitTop + (event.changedTouches[0].pageY - touchStartY) + 'px';
//							divMountain3.style.top = divMountain3InitTop + (event.changedTouches[0].pageY - touchStartY) + 'px';
//						}
//					}
//					//取消拖动
//					event.preventDefault();
//				}, false);
//				//拖动结束
//				document.body.addEventListener('touchend', function (event) {
//					if (finishInit){
//						//回到原来位置
//						tweenMainButtonAnimationBack = TweenLite.to(divMainButton, 1, {top: divMainButtonInitTop + "px", onComplete:function(){
//							//开始主键动画
//							setMainButtonAnimation();
//						}});
//						tweenMountain1AnimationBack = TweenLite.to(divMountain1, 1, {top: divMountain1InitTop + "px"});
//						tweenMountain2AnimationBack = TweenLite.to(divMountain2, 1, {top: divMountain2InitTop + "px"});
//						tweenMountain3AnimationBack = TweenLite.to(divMountain3, 1, {top: divMountain3InitTop + "px"});
//					}
//				}, false);
				isIOS = plus.os.name.toLowerCase().indexOf('ios') >= 0;
				plus.screen.lockOrientation("portrait-primary");	//锁定竖屏
				plus.device.setWakelock(true);		//屏幕常亮
				styleWithTime = utility.getStyleWithTime();
				//背景
				var divGB = document.getElementById("divGB");
				divGB.style.height = window.innerHeight + 'px';
				divGB.style.background = styleWithTime.bg;
				//moutain1
				divMountain1.style.backgroundImage = "url(image/" + styleWithTime.mountain1 + ")";
				divMountain1.style.height = divMountain1.clientWidth * 0.4 + 'px';
				divMountain1.style.top =  window.innerHeight + 'px';
				//mountain2
				divMountain2.style.backgroundImage = "url(image/" + styleWithTime.mountain2 + ")";
				divMountain2.style.height = divMountain2.clientWidth * 0.4 + 'px';
				divMountain2.style.top =  window.innerHeight + 'px';
				//mountain2
				divMountain3.style.backgroundImage = "url(image/" + styleWithTime.mountain3 + ")";
				divMountain3.style.height = divMountain3.clientWidth * 0.4 + 'px';
				divMountain3.style.top =  window.innerHeight + 'px';
				//初始化主按钮
				divMainButton.style.backgroundColor = styleWithTime.mainButtonColor;
				divMainButton.style.boxShadow = "0px 0px 10px 2px " + styleWithTime.mainButtonColor;
				divMainButton.style.width = divMainButton.style.height = window.innerHeight / 5 + "px";
				divMainButton.style.left = (window.innerWidth / 2) - (divMainButton.clientWidth / 2) + "px";
				//内容
				divDiaryList.style.backgroundColor = styleWithTime.timelineBgColor;
				//箭头的背景色
				var newStyleElement = document.createElement('style');
				newStyleElement.innerText = ".divDiaryContentItem:after {border-right-color: " + styleWithTime.mainButtonColor + ";} ";
				newStyleElement.innerText += ".mui-table-view-cell.mui-active>.mui-slider-handle {background-color: " + styleWithTime.timelineActiveItmeBgColor + "}";
				document.body.appendChild(newStyleElement);
				//滚动事件
				window.onscroll = function (e) {
				  console.log(window.pageYOffset);
				}
				//初始化的位置
				//ios上有动画
				if (isIOS){
					TweenLite.to(divMountain1, 0.5, {top: window.innerHeight - divMountain1.clientHeight / 1.2 + 'px'});
					TweenLite.to(divMountain2, 0.8, {top: window.innerHeight - divMountain1.clientHeight / 1.2 - 20 + 'px'});
					TweenLite.to(divMountain3, 1, {top: window.innerHeight - divMountain1.clientHeight / 1.2 - 20 + 'px'});
					TweenLite.to(divMainButton, 1, {top: window.innerHeight / 3 + "px", onComplete:completeInit});
				}
				else {
					divMountain1.style.top = window.innerHeight - divMountain1.clientHeight / 1.2 + 'px';
					divMountain2.style.top = window.innerHeight - divMountain1.clientHeight / 1.2 - 20 + 'px';
					divMountain3.style.top = window.innerHeight - divMountain1.clientHeight / 1.2 - 20 + 'px';
					divMainButton.style.top = window.innerHeight / 3 + "px";
					completeInit();
				}
				//获取日记列表
				var diaryList = getDiaryList();
				//显示日记列表
				renderDiaryList(diaryList);
			});
			
			/**
			 * 完成初始化
			 */
			function completeInit(){
				finishInit = true;
				setMainButtonAnimation();
				divMountain1InitTop = divMountain1.offsetTop;
				divMountain2InitTop = divMountain2.offsetTop;
				divMountain3InitTop = divMountain3.offsetTop;
			} 
			
			/**
			 * 设置主按按钮的动画
			 */
			function setMainButtonAnimation(){
				divMainButtonInitTop = divMainButton.offsetTop;
				//升起
				function setMainButtonAnimationUP(){
					tweenAnimationUP = TweenLite.to(divMainButton, 2, {
						top: divMainButtonInitTop - 12 + "px", 
						boxShadow: "0px 0px 0px 0px " + styleWithTime.mainButtonColor,
						onComplete: setMainButtonAnimationDown,
					});
				}
				//下降
				function setMainButtonAnimationDown(){
					tweenAnimationDown = TweenLite.to(divMainButton, 2, {
						top: divMainButtonInitTop + 12 + "px",
						boxShadow: "0px 0px 20px 8px " + styleWithTime.mainButtonColor,
						onComplete: setMainButtonAnimationUP
					});
				}
				setMainButtonAnimationUP();
			}
			/**
			 * 获取日记列表
			 */
			function getDiaryList(){
				var result = [];
				result.push({
					date: '2016-12-09',
					weather: 'fine',
					content: '为了保证扩展API的有效调用，所有应用页面都会用到的重要事件。 应用页面显示时需要首先加载扩展和API代码库，当扩展API代码库加载完成时会触发pluseready事件，当设备触发该事件后，用户就可以安全的调用扩展API。 如果程序中打开多个页面，每个都会收到此事件。',
					image: 'assets/image/IMG_1001.JPG',
					expression: 'happy',
					hasPicture: true,
					hasAudio: true,
					hasVideo: true,
					hasLast: false,
					hasNext: true
				});
				result.push({
					date: '2016-12-09',
					weather: 'rain',
					content: '为了保证扩展API的有效调用，所有应用页面都会用到的重要事件。 应用页面显示时需要首先加载扩展和API代码库，当扩展API代码库加载完成时会触发pluseready事件，当设备触发该事件后，用户就可以安全的调用扩展API。 如果程序中打开多个页面，每个都会收到此事件。',
					image: 'assets/image/IMG_1001.JPG',
					expression: 'anger',
					hasPicture: true,
					hasAudio: false,
					hasVideo: false,
					hasLast: true,
					hasNext: true
				});
				result.push({
					date: '2016-12-09',
					weather: 'rain',
					content: '为了保证扩展API的有效调用，所有应用页面都会用到的重要事件。 应用页面显示时需要首先加载扩展和API代码库，当扩展API代码库加载完成时会触发pluseready事件，当设备触发该事件后，用户就可以安全的调用扩展API。 如果程序中打开多个页面，每个都会收到此事件。',
					image: 'assets/image/IMG_1001.JPG',
					expression: 'anger',
					hasPicture: true,
					hasAudio: false,
					hasVideo: false,
					hasLast: true,
					hasNext: true
				});
				result.push({
					date: '2016-12-09',
					weather: 'rain',
					content: '为了保证扩展API的有效调用，所有应用页面都会用到的重要事件。 应用页面显示时需要首先加载扩展和API代码库，当扩展API代码库加载完成时会触发pluseready事件，当设备触发该事件后，用户就可以安全的调用扩展API。 如果程序中打开多个页面，每个都会收到此事件。',
					image: 'assets/image/IMG_1001.JPG',
					expression: 'anger',
					hasPicture: true,
					hasAudio: false,
					hasVideo: false,
					hasLast: true,
					hasNext: true
				});
				result.push({
					date: '2016-12-09',
					weather: 'cloudy',
					content: '为了保证扩展API的有效调用，所有应用页面都会用到的重要事件。 应用页面显示时需要首先加载扩展和API代码库，当扩展API代码库加载完成时会触发pluseready事件，当设备触发该事件后，用户就可以安全的调用扩展API。 如果程序中打开多个页面，每个都会收到此事件。',
					expression: 'cry',
					hasPicture: false,
					hasAudio: true,
					hasVideo: true,
					hasLast: true,
					hasNext: false
				});
				return result;
			}
			/**
			 * 渲染日记列表
			 */
			function renderDiaryList(list){
				for(var i = 0; i < list.length; i++){
					renderDiaryItem(list[i]);
				}
				//如果有diary,就显示第一个
				if (list.length > 0){
					var scrollHeight = 0;
					if (list.length == 1){
						scrollHeight = 100;
					}
					else {
						scrollHeight = 150;
					}
					TweenLite.to(window, 1, {scrollTo:scrollHeight});
				}
			}
			
			/**
			 * @description 渲染一条日记
			 * @param {Object} item
			 */
			function renderDiaryItem(item){
				var itemDate = moment(item.date);
				item.dayOfWeek = itemDate.weekday();
				if (item.dayOfWeek == 0){
					item.dayOfWeekChinese = "星期一";
				}
				else if (item.dayOfWeek == 1){
					item.dayOfWeekChinese = "星期二";
				}
				else if (item.dayOfWeek == 2){
					item.dayOfWeekChinese = "星期三";
				}
				else if (item.dayOfWeek == 3){
					item.dayOfWeekChinese = "星期四";
				}
				else if (item.dayOfWeek == 4){
					item.dayOfWeekChinese = "星期五";
				}
				else if (item.dayOfWeek == 5){
					item.dayOfWeekChinese = "星期六";
				}
				else if (item.dayOfWeek == 6){
					item.dayOfWeekChinese = "星期天";
				}
				item.yearMonth = itemDate.format("YYYY.M");
				item.day = itemDate.format("D");
				var html = templateDiaryItem(item);
				var li = document.createElement("li");
				li.innerHTML = html;
				li.className = "mui-table-view-cell";
				//自动显示省略号
				var divDiaryText = li.getElementsByClassName('divDiaryContentText')[0];
				$clamp(divDiaryText, {clamp: 3});
				//调整颜色
				li.getElementsByClassName('divDiaryTimelineLeft')[0].style.color = styleWithTime.mainButtonColor;
				li.getElementsByClassName('divTimelineLineContainer')[0].style.color = styleWithTime.mainButtonColor;
				li.getElementsByClassName('divTimelineLineContainer')[0].style.borderColor = styleWithTime.mainButtonColor;
				li.getElementsByClassName('divTimelineLineDown')[0].style.borderColor = styleWithTime.mainButtonColor;
				li.getElementsByClassName('divDiaryContentItem')[0].style.background = styleWithTime.mainButtonColor;
				ulDairyList.appendChild(li);
			}
			
			/**
			 * 改变svg颜色
			 * @param {Object} e
			 */
			function changSvgColor(sender){
				utility.setSvgColor({
					containerArray : [sender], 
					color: styleWithTime.mainButtonColor
				});
			}
		</script>
	</body>

</html>